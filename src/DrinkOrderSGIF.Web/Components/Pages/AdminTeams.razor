@page "/admin/teams"
@inherits AdminPageBase

@inject ITeamService TeamService

<PageTitle>Administrer hold</PageTitle>

@if (!IsAuthorized)
{
    <p>Sender til login-siden...</p>
}
else
{
    <h1>Hold</h1>

    <div class="admin-form">
        <input placeholder="Nyt holdnavn" @bind="_newTeamName" />
        <button class="order-button" @onclick="AddTeam">Tilf√∏j hold</button>
    </div>

    @if (_teams.Count == 0)
    {
        <p>Ingen hold oprettet endnu.</p>
    }
    else
    {
        <div class="admin-list">
            @foreach (var team in _teams)
            {
                <div class="admin-row">
                    <div>
                        @if (_editingTeamId == team.Id)
                        {
                            <input placeholder="Holdnavn" @bind="_editingTeamName" />
                        }
                        else
                        {
                            <strong>@team.Name</strong>
                        }
                        <span class="status-tag">@((team.IsActive) ? "Aktiv" : "Inaktiv")</span>
                    </div>
                    <div class="admin-actions">
                        @if (_editingTeamId == team.Id)
                        {
                            <button class="order-button" @onclick="() => SaveTeamEdit(team)">Gem</button>
                            <button class="secondary-button" @onclick="CancelTeamEdit">Annuller</button>
                        }
                        else
                        {
                            <button class="secondary-button" @onclick="() => StartTeamEdit(team)">Rediger</button>
                            <button class="secondary-button" @onclick="() => ToggleTeam(team)">
                                @(team.IsActive ? "Fjern" : "Gendan")
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
}

@code {
    private string _newTeamName = string.Empty;
    private IReadOnlyList<Team> _teams = Array.Empty<Team>();
    private Guid? _editingTeamId;
    private string _editingTeamName = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && await EnsureAuthorizedAsync())
        {
            await LoadTeamsAsync();
            StateHasChanged();
        }
    }

    private async Task LoadTeamsAsync()
    {
        _teams = await TeamService.GetAllTeamsAsync();
    }

    private async Task AddTeam()
    {
        if (string.IsNullOrWhiteSpace(_newTeamName))
        {
            return;
        }

        await TeamService.AddTeamAsync(_newTeamName);
        _newTeamName = string.Empty;
        await LoadTeamsAsync();
    }

    private void StartTeamEdit(Team team)
    {
        _editingTeamId = team.Id;
        _editingTeamName = team.Name;
    }

    private void CancelTeamEdit()
    {
        _editingTeamId = null;
        _editingTeamName = string.Empty;
    }

    private async Task SaveTeamEdit(Team team)
    {
        if (_editingTeamId != team.Id || string.IsNullOrWhiteSpace(_editingTeamName))
        {
            return;
        }

        await TeamService.UpdateTeamAsync(team.Id, _editingTeamName);
        await LoadTeamsAsync();
        CancelTeamEdit();
    }

    private async Task ToggleTeam(Team team)
    {
        await TeamService.SetTeamActiveAsync(team.Id, !team.IsActive);
        await LoadTeamsAsync();
    }
}
