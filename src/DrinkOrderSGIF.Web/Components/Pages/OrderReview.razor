@page "/order/review"

@inject IOrderService OrderService
@inject OrderDraftState DraftState
@inject NavigationManager Navigation

<PageTitle>Gennemgå Ordre</PageTitle>

@if (_submitted)
{
    <h1>Bestilling bekræftet</h1>
    <p>Din bestilling er på vej til dit bord.</p>
    <button class="order-button" @onclick="ReturnHome">Tilbage til hold valg.</button>
}
else if (DraftState.TeamId is null || DraftState.Items.Count == 0)
{
    <p>Ingen drinks er i din bestilling endnu.</p>
    <button class="order-button" @onclick="ReturnHome">Tilbage til hold valg.</button>
}
else
{
    <h1>Gennemgå bestilling for @DraftState.TeamName</h1>

    <div class="review-list">
        @foreach (var item in DraftState.Items)
        {
            <div class="review-row">
                <span>@item.DrinkName</span>
                @if (item.KlipsPrice.HasValue)
                {
                    <span>@item.TotalUnits enheder - @item.IncrementCount x @item.Price DKK / @item.IncrementCount x @item.KlipsPrice.Value Klips</span>

                }
                else
                {
                    <span>@item.TotalUnits enheder - @item.IncrementCount x @item.Price DKK</span>

                }
            </div>
        }
    </div>

    <div class="order-actions">
        <span>Totale drinks: @TotalItems</span>
        <span>Totale i DKK (alt i DKK): @TotalDkkAll</span>
        <span>Totale i Klips: @TotalKlips</span>
        <span>Obligatorisk DKK: @MandatoryDkk</span>
        <button class="order-button" @onclick="PlaceOrder">Placér Order</button>
    </div>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <p class="error-text">@_error</p>
    }
}

@code {
    private bool _submitted;
    private string? _error;

    private int TotalItems => DraftState.Items.Sum(item => item.TotalUnits);
    private int TotalDkkAll => DraftState.TotalPrice;
    private int TotalKlips => DraftState.TotalKlips;
    private int MandatoryDkk => DraftState.MandatoryDkk;

    private async Task PlaceOrder()
    {
        if (DraftState.TeamId is null)
        {
            return;
        }

        _error = null;

        try
        {
            var request = new OrderRequest(
                DraftState.TeamId.Value,
                DraftState.Items.Select(item => new OrderItemRequest(item.DrinkId, item.TotalUnits)).ToList());
            await OrderService.CreateOrderAsync(request);
            DraftState.Clear();
            _submitted = true;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private void ReturnHome()
    {
        DraftState.Clear();
        Navigation.NavigateTo("/");
    }
}
