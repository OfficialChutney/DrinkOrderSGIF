@page "/order/{TeamId:guid}"

@inject ITeamService TeamService
@inject IDrinkService DrinkService
@inject OrderDraftState DraftState
@inject NavigationManager Navigation

@using System.Globalization

<PageTitle>Bestil Drinks</PageTitle>

@if (_team is null)
{
    <p>Holdet kunne ikke findes. Return√©r til forsiden.</p>
}
else
{
    <h1>Bestilling for @_team.Name</h1>

    @if (_drinks.Count == 0)
    {
        <p>Det er ikke muligt at bestille lige nu.</p>
    }
    else
    {
        <div class="drink-list">
            @foreach (var drink in _drinks)
            {
                var quantity = DraftState.GetQuantity(drink.Id);
                <div class="drink-row">
                    <div>
                        <div class="drink-name">@drink.Name</div>
                        <div class="order-subtitle">
                            
                            @if (drink.KlipsPrice.HasValue)
                            {
                                <span>Pris: @(drink.Price * quantity) DKK / @FormatKlips(drink.KlipsPrice.Value * quantity) Klips</span>
                            }
                            else
                            {
                                <span>Pris: @drink.Price DKK</span>

                            }
                        </div>
                    </div>
                    <div class="drink-controls">
                        <button class="qty-button" @onclick="() => Decrement(drink.Id)">-</button>
                        <span class="qty-value">@quantity</span>
                        <button class="qty-button" @onclick="() => Increment(drink)">+</button>
                    </div>
                </div>
            }
        </div>

        <div class="order-actions">
            <span>Totale drinks: @TotalItems</span>
            <span>Totale i DKK (alt i DKK): @TotalDkkAll</span>
            <span>Totale i Klips: @TotalKlips</span>
            <span>Obligatorisk DKK: @MandatoryDkk</span>
            <button class="order-button" disabled="@(_team is null || TotalItems == 0)" @onclick="GoToReview">
                Se samlet ordrer
            </button>
        </div>
    }
}

@code {
    [Parameter]
    public Guid TeamId { get; set; }

    private Team? _team;
    private IReadOnlyList<Drink> _drinks = Array.Empty<Drink>();

    private int TotalItems => DraftState.Items.Sum(item => item.TotalUnits);
    private int TotalDkkAll => DraftState.TotalPrice;
    private string TotalKlips => FormatKlips(DraftState.TotalKlips);
    private int MandatoryDkk => DraftState.MandatoryDkk;

    protected override async Task OnParametersSetAsync()
    {
        _team = await TeamService.GetTeamByIdAsync(TeamId);
        if (_team is not null && _team.IsActive)
        {
            DraftState.SetTeam(_team.Id, _team.Name);
            _drinks = await DrinkService.GetActiveDrinksAsync();
        }
        else
        {
            _team = null;
        }
    }

    private void Increment(Drink drink)
    {
        DraftState.Increment(drink.Id, drink.Name, drink.Price, drink.KlipsPrice);
    }

    private void Decrement(Guid drinkId)
    {
        DraftState.Decrement(drinkId);
    }

    private void GoToReview()
    {
        Navigation.NavigateTo("/order/review");
    }

    private static string FormatKlips(decimal value)
    {
        return value.ToString("0.##", System.Globalization.CultureInfo.GetCultureInfo("da-DK"));
    }
}
